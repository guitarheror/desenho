<!DOCTYPE html>
<html>
<head>
  <title>Rastreamento de Âncora em Tempo Real</title>
  <style>
    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    video {
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>
<body>
  <input type="file" accept="image/*" id="anchor-input" />
  <video id="video" autoplay></video>
  <canvas id="canvas"></canvas>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const anchorInput = document.getElementById('anchor-input');

    let anchorImage = null;
    let anchorPattern = null;
    let scaleFactor = 1;

    // Configura a câmera traseira
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        });
      })
      .catch(err => console.error('Erro ao acessar a câmera:', err));

    // Carrega a imagem da âncora e seleciona a área desejada
    anchorInput.addEventListener('change', event => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();

      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          anchorImage = img;
          anchorPattern = ctx.createPattern(anchorImage, 'no-repeat');
          // Aqui você pode adicionar a lógica de corte (usando uma segunda canvas para seleção, por exemplo)
          alert('Âncora carregada! Agora ela será rastreada ao vivo.');
        };
        img.src = e.target.result;
      };

      reader.readAsDataURL(file);
    });

    // Função principal para rastrear a âncora e projetar o desenho
    function trackAndProject() {
      if (!anchorImage) return requestAnimationFrame(trackAndProject);

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // TODO: Implementar o rastreamento da âncora em tempo real aqui
      // Aqui você pode usar bibliotecas como OpenCV.js para identificar a posição da âncora
      // Por enquanto, faremos apenas uma simulação de projeção

      const x = canvas.width / 2 - anchorImage.width / 4;
      const y = canvas.height / 2 - anchorImage.height / 4;
      const width = anchorImage.width * scaleFactor;
      const height = anchorImage.height * scaleFactor;

      ctx.drawImage(anchorImage, x, y, width, height);

      requestAnimationFrame(trackAndProject);
    }

    trackAndProject();

    // Permite ajustar o tamanho da projeção
    document.addEventListener('keydown', event => {
      if (event.key === '+') scaleFactor += 0.1;
      if (event.key === '-') scaleFactor -= 0.1;
    });
  </script>
</body>
</html>
